<html>
    <head>
		<script src="https://surikov.github.io/webaudiofont/npm/dist/WebAudioFontPlayer.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12835_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12836_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12837_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12838_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12839_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12840_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12841_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12842_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12843_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12844_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12845_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12846_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12847_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12848_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12849_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12850_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12851_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12852_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12853_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12854_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12855_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12856_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12857_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12858_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12859_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12860_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12861_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12862_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12863_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12864_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12865_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12866_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12867_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12868_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12869_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12870_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12871_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12872_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12873_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12874_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12875_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12876_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12877_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12878_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12879_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12880_0_Chaos_sf2_file.js"></script>
		<script src="https://surikov.github.io/webaudiofontdata/sound/12881_0_Chaos_sf2_file.js"></script>

		
		
		
        <script src="https://d3js.org/d3.v5.min.js"></script>
        <link href="https://fonts.googleapis.com/css?family=Oswald&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
        <style>
            .chordNodeCircle {
                stroke-width:2;
            }

            body {
              font-family: 'Oswald', sans-serif;
              font-size:12px;
            }

            .chordNodeText {
            font-family: 'Oswald', sans-serif;
            font-size:20px;
            fill:lightgray;
            text-anchor:middle;
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* IE10+/Edge */
            user-select: none; /* Standard */
            }

            .button {
                background-color: #e7e7e7; color: black; /* Green */
                border: none;
                color: white;
                padding: 15px 32px;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 16px;
            }
			
			.beat {
				fill:white;
				stroke-width:2;
				stroke:lightgray;
			}
			
			.beat-checked {
				fill:steelblue;
				stroke-width:2;
				stroke:lightgray;
			}
			
			.karaokebeat {
				fill:coral;
				stroke:coral;
			}
            
        </style>
    </head>
    <body>
      <center>
      <p style="font-size:20px;">Rhythmic canons mod 2</p><br><br>
    </center>
      <div class="container-fluid">
        <div class="row">
          <div class="col-2">
              <p style="text-align:justify">
              A <i>rhythmic canon 'modulo 2'</i> is a periodic tiling of the line by a pattern of beats, such
              that only an odd number of players play on each beat (<i>'modulo 2'</i>).
              </p>
              <p style="text-align:justify">
              Click on the beats on the top to create a motive. Click 'Get canon mod 2' to create the smallest
              compact rhythmic canon modulo 2 with this motive, which will appear below. The pattern of the motive and
              the pattern of the players' entries can be swapped, thus creating a new canon.
              </p>
              <p style="text-align:justify">
              For more information, please consult the references below:
              <ul>
              <li>Amiot, E.; 'Structures, Algorithms and algebraic tools for rythmic canons', Perspectives
of New Music, 49 (2), 2011, pp. 93-142.
              </li>
              <li>Caure, H.; 'Modulus p Vuza canons: generalities and resolution of the case {0,1,2<sup>k</sup>} with p=2', arXiv:1505.06930.
              </li>
              </ul>
              </p>
              <p style="text-align:justify">
              Visualization and code by Alexandre Popoff.
              Best viewed with Chrome or Firefox. Compatibility with Internet Explorer and Microsoft Edge is not guaranteed.
              </p>
        </div>
        <div class="col-sm-8">
			  <p style="font-size:18px;">Motive:</p><svg id="PATTERNSVG"></svg>
			  <br>
			  <button type="button" class="btn btn-secondary" onclick="generateCanon();">Get canon mod 2</button>
			  <button type="button" class="btn btn-secondary" onclick="revertCanon();">Swap entries/parts</button>
              <p style="font-size:18px; display:inline; vertical-align: -4px;">Tempo :</p>
              <svg width="100" height="20" id="TEMPOSVG" style="display:inline;"></svg>
              <p style="font-size:18px; display:inline; vertical-align: -4px;" id="tempoValue"></p>
			  <button type="button" class="btn btn-secondary" onclick="playCanon();">Play</button>
			  <button type="button" class="btn btn-secondary" onclick="javascript:stopCanon();">Stop</button>
			  <br>
			  <br>
		<div class="row">
          <div class="col-2 col-2" id="instrumentSelection">
		  </div>
		  <div class="col-2 col-3">
			  <svg id="CANONSVG"></svg>
		  </div>
        </div>
      </div>
    </div>


    </body>
    		<script>
			
		var DRUM_LIST = [{"label":"Bass Drum 2","pitch":35,"object":_drum_35_0_Chaos_sf2_file},
						 {"label":"Bass Drum 1","pitch":36,"object":_drum_36_0_Chaos_sf2_file},
						 {"label":"Side Stick","pitch":37,"object":_drum_37_0_Chaos_sf2_file},
						 {"label":"Snare Drum 1","pitch":38,"object":_drum_38_0_Chaos_sf2_file},
						 {"label":"Hand Clap","pitch":39,"object":_drum_39_0_Chaos_sf2_file},
						 {"label":"Snare Drum 2","pitch":40,"object":_drum_40_0_Chaos_sf2_file},
						 {"label":"Low Tom 2","pitch":41,"object":_drum_41_0_Chaos_sf2_file},
						 {"label":"Closed Hi-hat","pitch":42,"object":_drum_42_0_Chaos_sf2_file},
						 {"label":"Low Tom 1","pitch":43,"object":_drum_43_0_Chaos_sf2_file},
						 {"label":"Pedal Hi-hat","pitch":44,"object":_drum_44_0_Chaos_sf2_file},
						 {"label":"Mid Tom 2","pitch":45,"object":_drum_45_0_Chaos_sf2_file},
						 {"label":"Open Hi-hat","pitch":46,"object":_drum_46_0_Chaos_sf2_file},
						 {"label":"Mid Tom 1","pitch":47,"object":_drum_47_0_Chaos_sf2_file},
						 {"label":"High Tom 2","pitch":48,"object":_drum_48_0_Chaos_sf2_file},
						 {"label":"Crash Cymbal 1","pitch":49,"object":_drum_49_0_Chaos_sf2_file},
						 {"label":"High Tom 1","pitch":50,"object":_drum_50_0_Chaos_sf2_file},
						 {"label":"Ride Cymbal 1","pitch":51,"object":_drum_51_0_Chaos_sf2_file},
						 {"label":"Chinese Cymbal","pitch":52,"object":_drum_52_0_Chaos_sf2_file},
						 {"label":"Ride Bell","pitch":53,"object":_drum_53_0_Chaos_sf2_file},
						 {"label":"Tambourine","pitch":54,"object":_drum_54_0_Chaos_sf2_file},
						 {"label":"Splash Cymbal","pitch":55,"object":_drum_55_0_Chaos_sf2_file},
						 {"label":"Cowbell","pitch":56,"object":_drum_56_0_Chaos_sf2_file},
						 {"label":"Crash Cymbal 2","pitch":57,"object":_drum_57_0_Chaos_sf2_file},
						 {"label":"Vibra Slap","pitch":58,"object":_drum_58_0_Chaos_sf2_file},
						 {"label":"Ride Cymbal 2","pitch":59,"object":_drum_59_0_Chaos_sf2_file},
						 {"label":"High Bongo","pitch":60,"object":_drum_60_0_Chaos_sf2_file},
						 {"label":"Low Bongo","pitch":61,"object":_drum_61_0_Chaos_sf2_file},
						 {"label":"Mute High Conga","pitch":62,"object":_drum_62_0_Chaos_sf2_file},
						 {"label":"Open High Conga","pitch":63,"object":_drum_63_0_Chaos_sf2_file},
						 {"label":"Low Conga","pitch":64,"object":_drum_64_0_Chaos_sf2_file},
						 {"label":"High Timbale","pitch":65,"object":_drum_65_0_Chaos_sf2_file},
						 {"label":"Low Timbale","pitch":66,"object":_drum_66_0_Chaos_sf2_file},
						 {"label":"High Agogo","pitch":67,"object":_drum_67_0_Chaos_sf2_file},
						 {"label":"Low Agogo","pitch":68,"object":_drum_68_0_Chaos_sf2_file},
						 {"label":"Cabasa","pitch":69,"object":_drum_69_0_Chaos_sf2_file},
						 {"label":"Maracas","pitch":70,"object":_drum_70_0_Chaos_sf2_file},
						 {"label":"Short Whistle","pitch":71,"object":_drum_71_0_Chaos_sf2_file},
						 {"label":"Long Whistle","pitch":72,"object":_drum_72_0_Chaos_sf2_file},
						 {"label":"Short Guiro","pitch":73,"object":_drum_73_0_Chaos_sf2_file},
						 {"label":"Long Guiro","pitch":74,"object":_drum_74_0_Chaos_sf2_file},
						 {"label":"Claves","pitch":75,"object":_drum_75_0_Chaos_sf2_file},
						 {"label":"High Wood Block","pitch":76,"object":_drum_76_0_Chaos_sf2_file},
						 {"label":"Low Wood Block","pitch":77,"object":_drum_77_0_Chaos_sf2_file},
						 {"label":"Mute Cuica","pitch":78,"object":_drum_78_0_Chaos_sf2_file},
						 {"label":"Open Cuica","pitch":79,"object":_drum_79_0_Chaos_sf2_file},
						 {"label":"Mute Triangle","pitch":80,"object":_drum_80_0_Chaos_sf2_file},
						 {"label":"Open Triangle","pitch":81,"object":_drum_81_0_Chaos_sf2_file}
						];
			
        var selectedPreset=_drum_35_0_Chaos_sf2_file;
        var AudioContextFunc = window.AudioContext || window.webkitAudioContext;
        var audioContext = new AudioContextFunc();
        var player=new WebAudioFontPlayer();

        function startWaveTableNow(drum,pitch) {
            player.queueWaveTable(audioContext, audioContext.destination, drum, audioContext.currentTime+0.02*Math.random(), pitch, 3.0,1.0);
        }

      function mod(n, m) {
          return ((n % m) + m) % m;
      }
	  
	  function stopCanon() {
		STOP_FLAG=1;
		player.cancelQueue(audioContext);
	  }
	  
	  function playCanon() {
		if (STOP_FLAG==1) {
            STOP_FLAG=0;
            var beatsData={};
            for (var i=0;i<CURRENT_CANON.length;i++) {
                beatsData[i]=[];
            }
          
            for (var i=0;i<CURRENT_CANON.entries.length;i++) {
                var e = CURRENT_CANON.entries[i];
                for (var j=0;j<CURRENT_CANON.motive.length;j++) {
                    selected_instrument = parseInt(d3.select("#entry_"+i.toString()).node().value);
                    beatsData[e+CURRENT_CANON.motive[j]].push([i,selected_instrument]);
                }
            }
            CANONSVG.append("line")
                    .attr("x1",5)
                    .attr("x2",5+beatSize)
                    .attr("y1",2)
                    .attr("y2",2)
                    .attr("class","karaokebeat");
            queueNextBeats(beatsData,0);
        }
	  }
	  
	  function queueNextBeats(beatsData,idx) {
		CANONSVG.selectAll(".karaokebeat")
				.attr("x1",5+beatSize*idx)
				.attr("x2",5+beatSize*(idx+1));
		for (var i=0;i<beatsData[idx].length;i++) {
			d = beatsData[idx][i];
			startWaveTableNow(DRUM_LIST[d[1]].object,DRUM_LIST[d[1]].pitch);
		}
		if (STOP_FLAG==0) {
			if (idx<CURRENT_CANON.length-1)
				setTimeout(function() {queueNextBeats(beatsData,idx+1)},60000.0/BPM);
			else
				setTimeout(function() {queueNextBeats(beatsData,0)},60000.0/BPM);
		} else {
			CANONSVG.selectAll(".karaokebeat").remove();
		}
	  }
	  
	  function get_canon(A) {
		sumArray = x => x.reduce((a,b) => a + b, 0);
	  
		var N = A[A.length-1];
		var H = new Array(N+1);
		H.fill(0);
		var arrSum = 0;
		var c=0;
		var entries=[];
		while (arrSum!=(N+1)) {
			var d = H.findIndex(x=>x==0);
			c = c+d;
			entries.push(c);
			
			var empty_array = new Array(d);
			empty_array.fill(0);
			H = (H.slice(d)).concat(empty_array);
			for (var i=0;i<A.length;i++) {
				H[A[i]] = (H[A[i]]+1)%2;
			}
			arrSum = sumArray(H);
		}
		return [entries,c+N+1];
	  }
	  
	  function generateCanon() {
		CURRENT_CANON={};
	  
		var allRects = PATTERNSVG.selectAll("rect")._groups[0];
		var N = allRects.length;
		var A = [];
		
		PATTERNSVG.selectAll("rect").each(function(d,i) {
							if (d3.select(this).attr("class")=="beat-checked") {
								A.push(i);
							}
							});
		canon_data = get_canon(A);
		CURRENT_CANON={"motive":A,"entries":canon_data[0],"length":canon_data[1]};
			
		redraw_canon();
	  }
	  
	  function revertCanon () {
		stopCanon();
		var A = CURRENT_CANON.motive;
		var E = CURRENT_CANON.entries;
		CURRENT_CANON.entries = A;
		CURRENT_CANON.motive = E;
		redraw_canon();
	  }
	  
	  function redraw_canon() {
		if (INSTRUMENT_SELECTION.length<CURRENT_CANON.entries.length) {
			var added_instruments = new Array(CURRENT_CANON.entries.length-INSTRUMENT_SELECTION.length);
			added_instruments.fill(0);
			INSTRUMENT_SELECTION = INSTRUMENT_SELECTION.concat(added_instruments);
		}
	  
		divSelection = d3.select("#instrumentSelection").selectAll("select").data(INSTRUMENT_SELECTION.slice(0,CURRENT_CANON.entries.length));
		divSelection.exit().style("display","none");
		divSelection.style("display","block");
		uh = divSelection.enter().append("select");
		uh.attr("id",function(d,i) {return "entry_"+i.toString()})
					.style("display","block")
					.style("position","absolute")
					.style("width",100)
					.style("height",beatSize*0.8)
					.style("top",function(d,i) {return 5+i*beatSize+0.1*beatSize});
		uh.selectAll("option").data(DRUM_LIST).enter()
					 .append("option")
					 .attr("value",function(d,i) {return i.toString()})
					 .html(function(d,i) {return d.label});
					
	  
	    CANONSVG.selectAll("rect").remove();
		CANONSVG.attr("width", 5+CURRENT_CANON.length*beatSize+20)
				.attr("height", 5+(CURRENT_CANON.entries.length)*beatSize+20)
				.attr("overflow","scroll");
		
		for (var j=0;j<CURRENT_CANON.entries.length;j++) {
			var e = CURRENT_CANON.entries[j];

			for (var i=0;i<CURRENT_CANON.length;i++) {
				var the_rect = CANONSVG.append("rect")
						  .attr("class","beat")
						  .attr("x",5+i*beatSize)
						  .attr("y",5+j*beatSize)
						  .attr("width",beatSize)
						  .attr("height",beatSize);
				for (var k=0;k<CURRENT_CANON.motive.length;k++) {
					if ((e+CURRENT_CANON.motive[k])==i)
						the_rect.attr("class","beat-checked");
				}
			}
		}
	  }
      
      function setBPM () {
        TEMPOSVG.selectAll("rect").remove();
        TEMPOSVG.append("rect")
                .attr("x",0)
                .attr("y",0)
                .attr("width",100)
                .attr("height",20)
                .attr("fill","lightgray");
        TEMPOSVG.append("rect")
                .attr("x",0)
                .attr("y",0)
                .attr("width",100*((BPM-30)/190))
                .attr("height",20)
                .attr("fill","coral");
        d3.select("#tempoValue").html(Math.round(BPM).toString()+" bpm");
      }
	  
		var beatSize = 25;
        var BPM=180;
		var INSTRUMENT_SELECTION=[];
		var STOP_FLAG=1;
		var CURRENT_CANON={};
	    var CANONSVG = d3.select("#CANONSVG");
        var TEMPOSVG = d3.select("#TEMPOSVG")
                         .on("click",function (d) {
                            coords = d3.mouse(this);
                            BPM = 30+190*(coords[0]/100.0);
                            setBPM();
                        });
		var PATTERNSVG = d3.select("#PATTERNSVG")
						   .attr("width", 600)
						   .attr("height", 100);
						   
		setBPM();
        for (var i=0;i<10;i++) {
			the_rect = PATTERNSVG.append("rect")
					  .attr("class","beat")
					  .attr("x",5+i*beatSize)
					  .attr("y",5)
					  .attr("width",beatSize)
					  .attr("height",beatSize);
			if (i>0)
				the_rect.on("click", function(d) {
									var obj = d3.select(this);
									if (obj.attr("class")=="beat-checked")
										d3.select(this).attr("class","beat");
									else {
										d3.select(this).attr("class","beat-checked");
									}
								  });
			else
				the_rect.attr("class","beat-checked");
					  
		}

		</script>

</html>